---
title: "The Effects of Income and Unemployment on Crime in Toronto"
author:
  # Enter your name and student number here:
- name: Annie Cheng
  student_number: 400298037
- name: Kenzie Dorgelo
  student_number: 400374596
- name: Sam Fanaki
  student_number: 400297172
- name: Iris Huang
  student_number: 400295138
- name: Jefferson Lam
  student_number: 400272316
- name: Yiyao Li
  student_number: 400258214
- name: William Russell
  student_number: 400199227
- name: Julian Vella
  student_number: 400408707
subject: "ENVSOCTY 4GA3: Applied Spatial Statistics"

# Do not edit below this line unless you know what you are doing
# --------------------------------------------------------------
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    # The project-template-default.tex file was heavily  adapted from Steven V. Miller's template for academic manuscripts. See:
    # http://svmiller.com/blog/2016/02/svm-r-markdown-manuscript/
    # https://github.com/svmiller/svm-r-markdown-templates/blob/master/svm-latex-ms.tex
    template: exercise-template-default.tex
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.align='center',
                      out.width = "0.8\\linewidth")
```

```{r}
library(sf)
library(ggplot2)
library(ggpubr)
library(scales)
library(spdep)
library(tidyverse)
library(spatialreg)

shapefile_path <- "C:/Users/willd/OneDrive/Desktop/Data/CrimesbyCT.shp"

ct_data <- st_read(shapefile_path)

ct_data <- st_transform(ct_data, 32617)

ggplot(ct_data) +
  geom_sf(fill = "gray", color = "black", size = 0.1) +
  coord_sf() +
  labs(fill = NULL) +
  theme_minimal() +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),  # Removes major grid lines
  panel.grid.minor = element_blank()   # Removes minor grid lines
)

ct_data$Robbery_rate <- ifelse(ct_data$Population > 0 & ct_data$Income != 0, 
                               (ct_data$Robbery / ct_data$Population) * 1000, NA)

ct_data$Auto_Theft_rate <- ifelse(ct_data$Population > 0 & ct_data$Income != 0, 
                                  (ct_data$Auto_Theft / ct_data$Population) * 1000, NA)

ct_data$Break_and_rate <- ifelse(ct_data$Population > 0 & ct_data$Income != 0, 
                                 (ct_data$Break_and / ct_data$Population) * 1000, NA)

ct_data$Theft_Over_rate <- ifelse(ct_data$Population > 0 & ct_data$Income != 0, 
                                  (ct_data$Theft_Over / ct_data$Population) * 1000, NA)

ct_data$Income[ct_data$Income == 0] <- NA

ct_data$Unemployme[ct_data$Unemployme == 0 & is.na(ct_data$Income)] <- NA
```

```{r}
ggplot(ct_data) +
  geom_sf(aes(fill = Income), color = "black", size = 0.1) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1, labels = comma) +
  coord_sf() +
  labs(fill = "Median Income ($)") +
  theme_minimal() +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),  
  panel.grid.minor = element_blank(),
  legend.title = element_text(size = 8)
)

ggplot(ct_data) +
  geom_sf(aes(fill = Unemployme), color = "black", size = 0.1) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1, labels = comma) +
  coord_sf() +
  labs(fill = "Unemployment Rate (%)") +
  theme_minimal() +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),  
  panel.grid.minor = element_blank(),
  legend.title = element_text(size = 8)
)

ggplot(ct_data) +
  geom_sf(aes(fill = Robbery_rate), color = "black", size = 0.1) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1, labels = comma) +
  coord_sf() +
  labs(fill = "Robbery Rate (per 1000 people)") +
  theme_minimal() +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),  
  panel.grid.minor = element_blank(),
  legend.title = element_text(size = 8)
)

ggplot(ct_data) +
  geom_sf(aes(fill = Auto_Theft_rate), color = "black", size = 0.1) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1, labels = comma) +
  coord_sf() +
  labs(fill = "Auto Theft Rate (per 1000 people)") +
  theme_minimal() +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),  
  panel.grid.minor = element_blank(),
  legend.title = element_text(size = 8)
)

ggplot(ct_data) +
  geom_sf(aes(fill = Break_and_rate), color = "black", size = 0.1) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1, labels = comma) +
  coord_sf() +
  labs(fill = "Break and Enter Rate (per 1000 people)") +
  theme_minimal() +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),  
  panel.grid.minor = element_blank(),
  legend.title = element_text(size = 8)
)

ggplot(ct_data) +
  geom_sf(aes(fill = Theft_Over_rate), color = "black", size = 0.1) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1, labels = comma) +
  coord_sf() +
  labs(fill = "Theft Over $5000 Rate (per 1000 people)") +
  theme_minimal() +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),  
  panel.grid.minor = element_blank(),
  legend.title = element_text(size = 8)
)

```

```{r}
ct_data <- ct_data %>%
  filter(complete.cases(Robbery_rate, Auto_Theft_rate, Break_and_rate, Theft_Over_rate))

centroids <- st_centroid(ct_data)
coords <- st_coordinates(centroids)

neighbors <- dnearneigh(coords, 0, 2222)
weights <- nb2listw(neighbors, style="W")

moran_robbery <- moran.test(ct_data$Robbery_rate, weights)
print(moran_robbery)

moran_auto_theft <- moran.test(ct_data$Auto_Theft_rate, weights)
print(moran_auto_theft)

moran_break_enter <- moran.test(ct_data$Break_and_rate, weights)
print(moran_break_enter)

moran_theft_over <- moran.test(ct_data$Theft_Over_rate, weights)
print(moran_theft_over)
```

```{r}
moran.plot(ct_data$Robbery_rate, weights, 
           xlab = "Standardized Robbery Rate", 
           ylab = "Spatial Lag of Standardized Robbery Rate", 
           main = "Moran's I Plot for Robbery Rate, per 1000 people")

moran.plot(ct_data$Auto_Theft_rate, weights, 
           xlab = "Standardized Auto Theft Rate", 
           ylab = "Spatial Lag of Standardized Auto Theft Rate", 
           main = "Moran's I Plot for Auto Theft Rate, per 1000 people")

moran.plot(ct_data$Break_and_rate, weights, 
           xlab = "Standardized Break and Enter Rate", 
           ylab = "Spatial Lag of Standardized Break and Enter Rate", 
           main = "Moran's I Plot for Break and Enter Rate, per 1000 people")

moran.plot(ct_data$Theft_Over_rate, weights, 
           xlab = "Standardized Theft Over $5000 Rate", 
           ylab = "Spatial Lag of Standardized Theft Over $5000 Rate", 
           main = "Moran's I Plot for Theft Over $5000 Rate, per 1000 people")
```



```{r}
# Transform 'Income' using natural logarithm
ct_data$Log_Unemployme <- log(ct_data$Unemployme + 1)  # Adding 1 to avoid log(0) which is undefined


# Transform 'Income' using natural logarithm
ct_data$Log_Income <- log(ct_data$Income + 1)  # Adding 1 to avoid log(0) which is undefined



Robbery1 = ggplot(data=ct_data, aes(x=Log_Income, y=Robbery_rate))+geom_point(size=1)+labs(x="Log of Median Income ($)", y="Robbery Rate (per 1000 people)", title="Correlation between Log-Transformed Median Income and Robbery Rate")

Robberycor1 <- cor.test(ct_data$Robbery_rate, ct_data$Income, method=c("kendall"))
print(Robberycor1)

logregRobbery1 <- lm(Robbery_rate ~ Log_Income, data = ct_data)
summary(logregRobbery1)
logreggraphRobbery1 <- Robbery1 + geom_smooth(method="lm", col="red") + stat_regline_equation(label.x=10.5, label.y=190)
logreggraphRobbery1


Robbery2 = ggplot(data=ct_data, aes(x=Unemployme, y=Robbery_rate))+geom_point(size=1)+labs(x="Unemployment Rate (%)", y="Robbery Rate (per 1000 people)", title="Correlation between Unemployment Rate and Robbery Rate")

Robberycor2 <- cor.test(ct_data$Robbery_rate, ct_data$Unemployme, method=c("kendall"))
print(Robberycor2)

quadregRobbery2 <- lm(Robbery_rate ~ poly(Unemployme, 2), data = ct_data)
summary(quadregRobbery2)
quadreggraphRobbery2 <- Robbery2 + geom_smooth(method = "lm", formula = y ~ poly(x, 2), col = "red") + 
  stat_regline_equation(label.x=0, label.y=190)
quadreggraphRobbery2
```

```{r}
Auto1 = ggplot(data=ct_data, aes(x=Income, y=Auto_Theft_rate))+geom_point(size=1)+labs(x="Median Income ($)", y="Auto Theft Rate (per 1000 people)", title="Correlation between Median Income and Auto Theft Rate")

Autocor1 <- cor.test(ct_data$Auto_Theft_rate, ct_data$Income, method=c("kendall"))
print(Autocor1)

linearregAuto1 <- lm(Auto_Theft_rate ~ Income, data = ct_data)
summary(linearregAuto1)
linearreggraphAuto1 <- Auto1 + geom_smooth(method="lm", col="red") + stat_regline_equation(label.x=300000, label.y=300)
linearreggraphAuto1


Auto2 = ggplot(data=ct_data, aes(x=Unemployme, y=Auto_Theft_rate))+geom_point(size=1)+labs(x="Unemployment Rate (%)", y="Auto Theft Rate (per 1000 people)", title="Correlation between Unemployment Rate and Auto Theft Rate")

Autocor2 <- cor.test(ct_data$Auto_Theft_rate, ct_data$Unemployme, method=c("kendall"))
print(Autocor2)

linearregAuto2 <- lm(Auto_Theft_rate ~ Unemployme, data = ct_data)
summary(linearregAuto2)
linearreggraphAuto2 <- Auto2 + geom_smooth(method="lm", col="red") + stat_regline_equation(label.x=0, label.y=300)
linearreggraphAuto2
```

```{r}
Break1 = ggplot(data=ct_data, aes(x=Income, y=Break_and_rate))+geom_point(size=1)+labs(x="Median Income ($)", y="Break and Enter Rate (per 1000 people)", title="Correlation between Median Income and Break and Enter Rate")

Breakcor1 <- cor.test(ct_data$Break_and_rate, ct_data$Income, method=c("kendall"))
print(Breakcor1)

linearregBreak1 <- lm(Break_and_rate ~ Income, data = ct_data)
summary(linearregBreak1)
linearreggraphBreak1 <- Break1 + geom_smooth(method="lm", col="red") + stat_regline_equation(label.x=300000, label.y=250)
linearreggraphBreak1


Break2 = ggplot(data=ct_data, aes(x=Unemployme, y=Break_and_rate))+geom_point(size=1)+labs(x="Unemployment Rate (%)", y="Break and Enter Rate (per 1000 people)", title="Correlation between Unemployment Rate and Break and Enter Rate")

Breakcor2 <- cor.test(ct_data$Break_and_rate, ct_data$Unemployme, method=c("kendall"))
print(Breakcor2)

linearregBreak2 <- lm(Break_and_rate ~ Unemployme, data = ct_data)
summary(linearregBreak2)
linearreggraphBreak2 <- Break2 + geom_smooth(method="lm", col="red") + stat_regline_equation(label.x=0, label.y=250)
linearreggraphBreak2
```

```{r}
TheftOver1 = ggplot(data=ct_data, aes(x=Income, y=Theft_Over_rate))+geom_point(size=1)+labs(x="Median Income ($)", y="Theft Over $5000 Rate (per 1000 people)", title="Correlation between Median Income and Theft Over $5000 Rate")

TheftOvercor1 <- cor.test(ct_data$Theft_Over_rate, ct_data$Income, method=c("kendall"))
print(TheftOvercor1)

linearregTheftOver1 <- lm(Theft_Over_rate ~ Income, data = ct_data)
summary(linearregTheftOver1)
linearreggraphTheftOver1 <- TheftOver1 + geom_smooth(method="lm", col="red") + stat_regline_equation(label.x=300000, label.y=150)
linearreggraphTheftOver1


TheftOver2 = ggplot(data=ct_data, aes(x=Unemployme, y=Theft_Over_rate))+geom_point(size=1)+labs(x="Unemployment Rate (%)", y="Theft Over $5000 Rate (per 1000 people)", title="Correlation between Unemployment Rate and Theft Over $5000 Rate")

TheftOvercor2 <- cor.test(ct_data$Theft_Over_rate, ct_data$Unemployme, method=c("kendall"))
print(TheftOvercor2)

cubregTheftOver2 <- lm(Theft_Over_rate ~ poly(Unemployme, 3), data = ct_data)
summary(cubregTheftOver2)
cubreggraphTheftOver2 <- TheftOver2 + geom_smooth(method = "lm", formula = y ~ poly(x, 3), col = "red") +
  stat_regline_equation(label.x=0, label.y=150)
cubreggraphTheftOver2
```

```{r}

ct_data$Income_scaled <- scale(ct_data$Income)
ct_data$Unemployme_scaled <- scale(ct_data$Unemployme)
ct_data$Log_Income_scaled <- scale(ct_data$Log_Income)
ct_data$Log_Unemployme_scaled <- scale(ct_data$Log_Unemployme)



# Robbery

# Define the exponential decay function
distance_decay_function <- function(d, bandwidth) {
  exp(-d / bandwidth)  # Ensure this operation is correctly vectorized
}

# Define a distance threshold and a bandwidth
robbery_threshold <- 3100  # Use the same threshold as before for consistency
robbery_bandwidth <- 1500  # Bandwidth for the decay function

# Create neighborhood structure
robbery_neighbors <- dnearneigh(coords, 0, robbery_threshold)
robbery_distances <- nbdists(robbery_neighbors, coords)

# Apply the decay function to each list of distances
robbery_decay_weights <- lapply(robbery_distances, function(d) distance_decay_function(d, robbery_bandwidth))

# Convert decayed distances to spatial weights
robbery_listw <- nb2listw(robbery_neighbors, glist=robbery_decay_weights, style="W")

# Example model fit using the spatial weights
robbery_lag_model <- lagsarlm(Robbery_rate ~ Log_Income_scaled + I(Unemployme_scaled^2), data=ct_data, listw=robbery_listw)
print(summary(robbery_lag_model))




# Auto Theft

# Define a distance threshold and a bandwidth
auto_threshold <- 2222  # Use the same threshold as before for consistency
auto_bandwidth <- 1500  # Bandwidth for the decay function

# Create neighborhood structure
auto_neighbors <- dnearneigh(coords, 0, auto_threshold)
auto_distances <- nbdists(auto_neighbors, coords)

# Apply the decay function to each list of distances
auto_decay_weights <- lapply(auto_distances, function(d) distance_decay_function(d, auto_bandwidth))

# Convert decayed distances to spatial weights
auto_listw <- nb2listw(auto_neighbors, glist=auto_decay_weights, style="W")

# Example model fit using the spatial weights
auto_lag_model <- lagsarlm(Auto_Theft_rate ~ Income_scaled, data=ct_data, listw=auto_listw)
print(summary(auto_lag_model))





# Break and Enter

# Define a distance threshold and a bandwidth
break_threshold <- 3800  # Use the same threshold as before for consistency
break_bandwidth <- 2000  # Bandwidth for the decay function

# Create neighborhood structure
break_neighbors <- dnearneigh(coords, 0, break_threshold)
break_distances <- nbdists(break_neighbors, coords)

# Apply the decay function to each list of distances
break_decay_weights <- lapply(break_distances, function(d) distance_decay_function(d, break_bandwidth))

# Convert decayed distances to spatial weights
break_listw <- nb2listw(break_neighbors, glist=break_decay_weights, style="W")

# Example model fit using the spatial weights
break_lag_model <- lagsarlm(Break_and_rate ~ Income_scaled + Unemployme_scaled, data = ct_data, listw=break_listw)
print(summary(break_lag_model))





# Theft over $5000

# Define a distance threshold and a bandwidth
theft_over_threshold <- 2222  # Use the same threshold as before for consistency
theft_over_bandwidth <- 1500  # Bandwidth for the decay function

# Create neighborhood structure
theft_over_neighbors <- dnearneigh(coords, 0, theft_over_threshold)
theft_over_distances <- nbdists(theft_over_neighbors, coords)

# Apply the decay function to each list of distances
theft_over_decay_weights <- lapply(theft_over_distances, function(d) distance_decay_function(d, theft_over_bandwidth))

# Convert decayed distances to spatial weights
theft_over_listw <- nb2listw(theft_over_neighbors, glist=theft_over_decay_weights, style="W")

# Example model fit using the spatial weights
theft_over_lag_model <- lagsarlm(Theft_Over_rate ~ Income_scaled + I(Unemployme_scaled^3), data = ct_data, listw=theft_over_listw)
print(summary(theft_over_lag_model))

```

```{r}
ct_data$predicted_robbery_lag <- as.numeric(predict(robbery_lag_model, newdata = ct_data, type = "response", listw = robbery_listw))

ggplot(data = ct_data) +
  geom_sf(aes(fill = predicted_robbery_lag), color = "black", size = 0.1) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1, labels = scales::comma) +
  labs(fill = "Predicted Robbery Rate (per 1000 people)") +
  theme_minimal() +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),  
  panel.grid.minor = element_blank(),
  legend.title = element_text(size = 8)
)

ct_data$predicted_auto_theft_lag <- as.numeric(predict(auto_lag_model, newdata = ct_data, type = "response", listw = auto_listw))

ggplot(data = ct_data) +
  geom_sf(aes(fill = predicted_auto_theft_lag), color = "black", size = 0.1) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1, labels = scales::comma) +
  labs(fill = "Predicted Auto Theft Rate (per 1000 people)") +
  theme_minimal() +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),  
  panel.grid.minor = element_blank(),
  legend.title = element_text(size = 8)
)

ct_data$predicted_break_enter_lag <- as.numeric(predict(break_lag_model, newdata = ct_data, type = "response", listw = break_listw))

ggplot(data = ct_data) +
  geom_sf(aes(fill = predicted_break_enter_lag), color = "black", size = 0.1) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1, labels = scales::comma) +
  labs(fill = "Predicted Break and Enter Rate (per 1000 people)") +
  theme_minimal() +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),  
  panel.grid.minor = element_blank(),
  legend.title = element_text(size = 8)
)

ct_data$predicted_theft_over_lag <- as.numeric(predict(theft_over_lag_model, newdata = ct_data, type = "response", listw = theft_over_listw))

ggplot(data = ct_data) +
  geom_sf(aes(fill = predicted_theft_over_lag), color = "black", size = 0.1) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1, labels = scales::comma, limits = c(0, max(ct_data$predicted_theft_over_lag, na.rm = TRUE))) +
  labs(fill = "Predicted Theft Over $5000 Rate (per 1000 people)") +
  theme_minimal() +
  theme(
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),  
  panel.grid.minor = element_blank(),
  legend.title = element_text(size = 8)
)
```
